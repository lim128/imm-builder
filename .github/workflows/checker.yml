name: Checker
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: "openwrt-24.10"

on:
  workflow_dispatch:
#  schedule:
#    - cron: 0 0 * * *

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@main

    - name: 获取最新tag
      id: get_latest_tag
      run: |
        # 使用 git 原生通配精确匹配 v24.10.* 系列 tag
        LATEST_TAG=$(git ls-remote --tags --refs ${{ env.REPO_URL }} 'refs/tags/v24.10.*' | \
                     cut -f2 | \
                     sed 's|^refs/tags/||' | \
                     sort -V | \
                     tail -n1)
        if [ -z "$LATEST_TAG" ]; then
          echo "【错误】未在 immortalwrt 仓库找到任何 v24.10 系列 tag！"
          exit 1
        fi
        echo "当前官方最新的 v24.10 系列 tag 为: $LATEST_TAG"
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT

    - name: 读取历史tag
      id: cache_tag
      uses: actions/cache@v3
      with:
        path: .latest_tag
        key: latest_tag_${{ steps.get_latest_tag.outputs.LATEST_TAG }}

    - name: 保存新tag
      if: steps.cache_tag.outputs.cache-hit != 'true'
      run: |
        echo ${{ steps.get_latest_tag.outputs.LATEST_TAG }} > .latest_tag
        echo "检测到新 tag: ${{ steps.get_latest_tag.outputs.LATEST_TAG }}，准备触发编译工作流"

    - name: 触发编译
      if: steps.cache_tag.outputs.cache-hit != 'true'
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ github.token }}
        event-type: Builder
        client-payload: |
          {
            "tag": "${{ steps.get_latest_tag.outputs.LATEST_TAG }}",
            "triggered_by": "tag-update-checker"
          }

    - name: 删除旧workflow
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 0
        keep_minimum_runs: 2
